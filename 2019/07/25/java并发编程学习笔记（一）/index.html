<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="java并发编程学习笔记（一）"><meta name="keywords" content="Java,并发"><meta name="author" content="MK"><meta name="copyright" content="MK"><title>java并发编程学习笔记（一） | MK's start</title><link rel="shortcut icon" href="/image/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?cae699147c4ac04308a32b867d0c5a88";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#线程安全性"><span class="toc-number">1.</span> <span class="toc-text">线程安全性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#竞态条件"><span class="toc-number">1.1.</span> <span class="toc-text">竞态条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#synchronized"><span class="toc-number">1.2.</span> <span class="toc-text">synchronized</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重入"><span class="toc-number">1.3.</span> <span class="toc-text">重入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#锁"><span class="toc-number">1.4.</span> <span class="toc-text">锁</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#对象的共享"><span class="toc-number">2.</span> <span class="toc-text">对象的共享</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#可见性"><span class="toc-number">2.1.</span> <span class="toc-text">可见性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#java中64位操作读写的原子性"><span class="toc-number">2.2.</span> <span class="toc-text">java中64位操作读写的原子性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#加锁与可见性"><span class="toc-number">2.3.</span> <span class="toc-text">加锁与可见性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Volatile变量"><span class="toc-number">2.4.</span> <span class="toc-text">Volatile变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#发布与逸出"><span class="toc-number">2.5.</span> <span class="toc-text">发布与逸出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#线程封闭"><span class="toc-number">2.6.</span> <span class="toc-text">线程封闭</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#栈封闭"><span class="toc-number">2.7.</span> <span class="toc-text">栈封闭</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreadLocal类"><span class="toc-number">2.8.</span> <span class="toc-text">ThreadLocal类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#不变性"><span class="toc-number">2.9.</span> <span class="toc-text">不变性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安全发布"><span class="toc-number">2.10.</span> <span class="toc-text">安全发布</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#懒汉模式"><span class="toc-number">2.10.1.</span> <span class="toc-text">懒汉模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#饿汉模式"><span class="toc-number">2.10.2.</span> <span class="toc-text">饿汉模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#双重同步锁"><span class="toc-number">2.10.3.</span> <span class="toc-text">双重同步锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用volatile关键字限制指令重排序"><span class="toc-number">2.10.4.</span> <span class="toc-text">使用volatile关键字限制指令重排序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用不可变对象"><span class="toc-number">2.10.5.</span> <span class="toc-text">使用不可变对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用枚举"><span class="toc-number">2.10.6.</span> <span class="toc-text">使用枚举</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#可变性与发布需求"><span class="toc-number">2.11.</span> <span class="toc-text">可变性与发布需求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#常用策略"><span class="toc-number">2.12.</span> <span class="toc-text">常用策略</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#对象的组合"><span class="toc-number">3.</span> <span class="toc-text">对象的组合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#设计线程安全类的三个要素"><span class="toc-number">3.1.</span> <span class="toc-text">设计线程安全类的三个要素</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#委托"><span class="toc-number">3.2.</span> <span class="toc-text">委托</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实例封闭"><span class="toc-number">3.3.</span> <span class="toc-text">实例封闭</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#扩展类加锁、客户端加锁"><span class="toc-number">3.4.</span> <span class="toc-text">扩展类加锁、客户端加锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#同步策略文档化"><span class="toc-number">3.5.</span> <span class="toc-text">同步策略文档化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基础构建模块"><span class="toc-number">4.</span> <span class="toc-text">基础构建模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#同步容器类"><span class="toc-number">4.1.</span> <span class="toc-text">同步容器类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#迭代器与ConcurrentModificationException"><span class="toc-number">4.2.</span> <span class="toc-text">迭代器与ConcurrentModificationException</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#隐藏的迭代器"><span class="toc-number">4.3.</span> <span class="toc-text">隐藏的迭代器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#并发容器类"><span class="toc-number">4.4.</span> <span class="toc-text">并发容器类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConcurrentHashMap"><span class="toc-number">4.5.</span> <span class="toc-text">ConcurrentHashMap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CopyOnWriteArrayList"><span class="toc-number">4.6.</span> <span class="toc-text">CopyOnWriteArrayList</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#阻塞队列"><span class="toc-number">4.7.</span> <span class="toc-text">阻塞队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#串行线程封闭"><span class="toc-number">4.8.</span> <span class="toc-text">串行线程封闭</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#阻塞方法与中断异常"><span class="toc-number">4.9.</span> <span class="toc-text">阻塞方法与中断异常</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#同步工具类"><span class="toc-number">4.10.</span> <span class="toc-text">同步工具类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#闭锁"><span class="toc-number">4.10.1.</span> <span class="toc-text">闭锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#信号量"><span class="toc-number">4.10.2.</span> <span class="toc-text">信号量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#栅栏"><span class="toc-number">4.10.3.</span> <span class="toc-text">栅栏</span></a></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/image/avatar.jpg"></div><div class="author-info__name text-center">MK</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">4</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">4</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">MK's start</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a></span></div><div id="post-info"><div id="post-title">java并发编程学习笔记（一）</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-07-25</time><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">2.7k</span><span class="post-meta__separator">|</span><span>阅读时长: 9 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="线程安全性"><a href="#线程安全性" class="headerlink" title="线程安全性"></a>线程安全性</h2><p>当多个线程访问某个类时，不管采用何种调度方式，或这些线程如何交替运行，并且在主调代码中不需要任何额外的同步或协同，这个类都能表现出正确的行为，就称这个类是线程安全的。</p>
<p>线程安全类在其中封装了必要的同步机制，因此客户端无须进一步采取同步措施</p>
<p>如<code>Hashtable</code>，它的许多方法前都加上了<code>synchronized</code>，因此是线程安全的。而<code>HashMap</code>如果想安全的使用，就要用<code>Collections.synchronizedMap(map)</code>,对原有map进行一次包装，即采取了同步措施。</p>
<p>无状态的对象一定是线程安全的。</p>
<h3 id="竞态条件"><a href="#竞态条件" class="headerlink" title="竞态条件"></a>竞态条件</h3><p>当结果的正确性取决于多个线程的交替执行顺序时，发生竞态条件。</p>
<p>最常见的竞态条件类型就是”先检查后执行“(Check-Then-Act)，即通过一个可能失效的观察结果来决定下一步的动作。</p>
<p>而”先检查后执行“的常见类型有”延迟初始化“、”读取-修改-写入“。</p>
<p>这些动作都需要以原子方式进行。</p>
<p>当无状态的类添加一个状态时，如果该状态完全由线程安全的对象来管理，那这个类仍是线程安全的。但多个状态变量就不一定了。</p>
<p>要保持状态的一致性，就需要在单个原子操作中更新所有相关的状态变量。</p>
<h3 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h3><p>同步代码块，包括了两部分，一个是锁的对象引用，一个是由这个锁保护的代码块。而以<code>synchronized</code>来修饰的方法就是横跨整个方法体的同步代码块，锁就是这个方法调用所在的对象。静态的<code>synchronized</code>方法以Class对象为锁。</p>
<p>每个Java对象都可以作为一个实现同步的锁，被称为内置锁或监视锁。</p>
<h3 id="重入"><a href="#重入" class="headerlink" title="重入"></a>重入</h3><p>因为内置锁是可重入的，如果一个线程试图获得一个已经由他持有的锁，这个请求会成功。这意味着，获取锁的粒度是线程而不是调用。一种实现方式就是为每个锁关联一个计数器和所有者的线程。</p>
<h3 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h3><p>对于可能被多个线程同时访问的可变状态变量，在访问它时都需要持有同一个锁，这时，称这个状态变量是由这个锁保护的。</p>
<p>一种常见的错误是，认为只有在写入变量时才需要进行同步。？？？</p>
<h2 id="对象的共享"><a href="#对象的共享" class="headerlink" title="对象的共享"></a>对象的共享</h2><h3 id="可见性"><a href="#可见性" class="headerlink" title="可见性"></a>可见性</h3><p>如下代码会产生死循环</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NoVisibility</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span>  <span class="keyword">static</span> <span class="keyword">boolean</span> ready;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> number;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">while</span> (!ready)</span><br><span class="line">                ;</span><br><span class="line">            System.out.println(number);</span><br><span class="line">        &#125;).start();</span><br><span class="line">        System.out.println(<span class="string">"start"</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1</span>);</span><br><span class="line">        number = <span class="number">42</span>;</span><br><span class="line">        ready = <span class="keyword">true</span>;</span><br><span class="line">        System.out.println(<span class="string">"end"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Thread.sleep(1);</code>这里是防止重排</p>
<p>其实idea已经给出了警告：</p>
<p>Reports on while loops which spin on the value of a non-volatile field, waiting for it to be changed by another thread.</p>
<p>这里建议我们用一个volatile的变量来代替。</p>
<p>原因就是这里永远也得不到改变后的ready的值。</p>
<h3 id="java中64位操作读写的原子性"><a href="#java中64位操作读写的原子性" class="headerlink" title="java中64位操作读写的原子性"></a>java中64位操作读写的原子性</h3><p>当线程把主存中的 long/double类型的值读到线程内存中时，可能是两次32位值的写操作，显而易见，如果几个线程同时操作，那么就可能会出现高低2个32位值出错的情况发生。即long,double高低位问题，非线程安全。（这只在32位的JVM上出现，64位没有这个问题）</p>
<h3 id="加锁与可见性"><a href="#加锁与可见性" class="headerlink" title="加锁与可见性"></a>加锁与可见性</h3><p>加锁的含义不仅仅局限于互斥行为，还包括内存可见性</p>
<h3 id="Volatile变量"><a href="#Volatile变量" class="headerlink" title="Volatile变量"></a>Volatile变量</h3><ul>
<li><p>volatile变量不会重排序。</p>
</li>
<li><p>volatile变量不会被缓存在寄存器或者对其他处理器不可见的地方，因此读取volatile变量总会返回最新写入的值。</p>
</li>
<li><p>没有锁，因此不会使线程阻塞，比synchronization更轻量</p>
</li>
<li><p>volatile变量常用来做某个操作完成、中断或状态改变的标志。</p>
</li>
<li><p>不足以保证count++的原子性。</p>
</li>
<li><p>加锁机制可以保证可见性和原子性，而volatile变量自能保证可见性。</p>
</li>
<li>当且仅当满足如下全部条件时，才能使用<ul>
<li>对变量的写入操作不依赖当前的值，或者确保只有单个线程能更新变量的值</li>
<li>该变量不会与其他变量一起纳入不变性条件中（没有关联）</li>
<li>访问变量不需要加锁</li>
</ul>
</li>
</ul>
<h3 id="发布与逸出"><a href="#发布与逸出" class="headerlink" title="发布与逸出"></a>发布与逸出</h3><p>“发布对象”指的是使对象能够在当前作用于之外的代码中使用</p>
<p>当某个不应该发布的对象被发布时，这种情况就被称为“对象逸出”。</p>
<p>不要在构造过程中使this逸出。</p>
<p>如果想在构造函数中注册一个事件监听器或启动线程，那么可以使用一个私有构造函数和一个公共的工厂方法（Factory Method），从而避免不正确的构造过程。</p>
<h3 id="线程封闭"><a href="#线程封闭" class="headerlink" title="线程封闭"></a>线程封闭</h3><p>数据仅仅在单个线程中访问，就不需要同步。</p>
<p>如<code>ThreadLoacl</code>类、JDBC连接池</p>
<p><code>volatile</code>变量存在一种特殊的线程封闭。如果能保证只有单个线程对这个变量执行写入操作，那么就可以安全的在这个变量上”读取-修改-写入“。相当于修改操作被封闭在了单个线程上，而其可见性保证了其他变量始终看到了最新的值。</p>
<h3 id="栈封闭"><a href="#栈封闭" class="headerlink" title="栈封闭"></a>栈封闭</h3><p>就是使用局部变量，这些变量位于执行线程的栈中，其他线程无法访问这个栈。但要注意不要使其逸出。</p>
<h3 id="ThreadLocal类"><a href="#ThreadLocal类" class="headerlink" title="ThreadLocal类"></a>ThreadLocal类</h3><p>这个类为每个线程都保存了一份副本，使用get、set等方法访问和修改。</p>
<p>如，每个线程都获取一个JDBC的连接、每个线程都需要一个临时对象，但又不想每次都重新生成。</p>
<p>不要滥用，这会增加类与类之间的耦合。</p>
<h3 id="不变性"><a href="#不变性" class="headerlink" title="不变性"></a>不变性</h3><p>不可变对象一定是线程安全的（废话）</p>
<p>尽量使用final域</p>
<p>当一组相关数据以原子方式执行某个操作时，可以使用一个不可变的类来包含这些数据。如缓存</p>
<h3 id="安全发布"><a href="#安全发布" class="headerlink" title="安全发布"></a>安全发布</h3><p>这里主要提及因为指令重排导致的不安全的发布。</p>
<h4 id="懒汉模式"><a href="#懒汉模式" class="headerlink" title="懒汉模式"></a>懒汉模式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnsafePublish</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">UnsafePublish</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> UnsafePublish instance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> UnsafePublish <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> UnsafePublish();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的问题不单单是有可能初始化多次，还有可能因为指令重排导致获取到了一个只创建了一半的对象。</p>
<h4 id="饿汉模式"><a href="#饿汉模式" class="headerlink" title="饿汉模式"></a>饿汉模式</h4><p>安全的办法，在声明静态变量时同时初始化，由JVM来保证初始化过程的安全性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SafePublish</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SafePublish</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SafePublish instance = <span class="keyword">new</span> SafePublish();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SafePublish <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的问题是如果构造方法中代码过多或类实例没有被使用会降低性能。</p>
<h4 id="双重同步锁"><a href="#双重同步锁" class="headerlink" title="双重同步锁"></a>双重同步锁</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Example</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Example</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Example instance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Example <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="comment">//双重检测机制</span></span><br><span class="line">            <span class="keyword">synchronized</span> (Example.class) &#123;<span class="comment">//同步锁</span></span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> Example();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里和饿汉模式一样，发生指令重排后，有可能获取到还没有初始化完成的实例。</p>
<h4 id="使用volatile关键字限制指令重排序"><a href="#使用volatile关键字限制指令重排序" class="headerlink" title="使用volatile关键字限制指令重排序"></a>使用volatile关键字限制指令重排序</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Example</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Example</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> Example instance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Example <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Example.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> Example();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="使用不可变对象"><a href="#使用不可变对象" class="headerlink" title="使用不可变对象"></a>使用不可变对象</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Example</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> x;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Example</span><span class="params">()</span></span>&#123;</span><br><span class="line">        x=<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Example instance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Example <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Example.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> Example();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由Java内存模型保证了不可变对象的初始化安全性。</p>
<h4 id="使用枚举"><a href="#使用枚举" class="headerlink" title="使用枚举"></a>使用枚举</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Example</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Example</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Example <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Singleton.INSTANCE.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">enum</span> Singleton&#123;</span><br><span class="line">        INSTANCE;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Example singleton;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//JVM保证绝对只被调用一次</span></span><br><span class="line">        Singleton()&#123;</span><br><span class="line">            singleton = <span class="keyword">new</span> Example();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Example <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> singleton;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="可变性与发布需求"><a href="#可变性与发布需求" class="headerlink" title="可变性与发布需求"></a>可变性与发布需求</h3><ul>
<li><p>不可变对象可以通过任意方式发布</p>
</li>
<li><p>事实不可变对象必须通过安全方式发布</p>
</li>
<li><p>可变对象必须通过安全方式发布，而且必须是线程安全的或者由某个锁保护起来</p>
</li>
</ul>
<h3 id="常用策略"><a href="#常用策略" class="headerlink" title="常用策略"></a>常用策略</h3><ul>
<li><p>线程封闭</p>
</li>
<li><p>只读共享</p>
</li>
<li>线程安全访问</li>
<li>保护对象</li>
</ul>
<h2 id="对象的组合"><a href="#对象的组合" class="headerlink" title="对象的组合"></a>对象的组合</h2><p>介绍一些构造线程安全类的常见技术</p>
<h3 id="设计线程安全类的三个要素"><a href="#设计线程安全类的三个要素" class="headerlink" title="设计线程安全类的三个要素"></a>设计线程安全类的三个要素</h3><ul>
<li>找出构成对象状态的所有变量</li>
<li>找出约束对象状态的不变性条件</li>
<li>建立对象状态的兵法访问管理策略</li>
</ul>
<h3 id="委托"><a href="#委托" class="headerlink" title="委托"></a>委托</h3><p>委托给已经线程安全的类来保证</p>
<h3 id="实例封闭"><a href="#实例封闭" class="headerlink" title="实例封闭"></a>实例封闭</h3><p>将数据封装在对象内部，限制访问和修改数据的方法。如<code>synchronizedMap</code>。</p>
<h3 id="扩展类加锁、客户端加锁"><a href="#扩展类加锁、客户端加锁" class="headerlink" title="扩展类加锁、客户端加锁"></a>扩展类加锁、客户端加锁</h3><p>找准原类的同步策略和锁，使用一致的锁。增加了耦合。或者干脆再用一个锁，用装饰器模式再封装一层。</p>
<h3 id="同步策略文档化"><a href="#同步策略文档化" class="headerlink" title="同步策略文档化"></a>同步策略文档化</h3><p>~~</p>
<h2 id="基础构建模块"><a href="#基础构建模块" class="headerlink" title="基础构建模块"></a>基础构建模块</h2><p>介绍java中常用的模块</p>
<h3 id="同步容器类"><a href="#同步容器类" class="headerlink" title="同步容器类"></a>同步容器类</h3><p>本身是线程安全的，但有时，一些复合操作如迭代、跳转、如果···则···就需要额外的同步策略。</p>
<h3 id="迭代器与ConcurrentModificationException"><a href="#迭代器与ConcurrentModificationException" class="headerlink" title="迭代器与ConcurrentModificationException"></a>迭代器与<code>ConcurrentModificationException</code></h3><p>防止迭代过程中被结构化的修改</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">checkForComodification</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (modCount != expectedModCount)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以通过加锁、克隆（克隆时也要加锁）的方式来避免</p>
<h3 id="隐藏的迭代器"><a href="#隐藏的迭代器" class="headerlink" title="隐藏的迭代器"></a>隐藏的迭代器</h3><p>如<code>toString</code>、<code>containsAll</code>等</p>
<h3 id="并发容器类"><a href="#并发容器类" class="headerlink" title="并发容器类"></a>并发容器类</h3><p>在上述问题的基础上，增加了对常见符合操作的支持。</p>
<h3 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h3><p>使用粒度更细的分段锁。</p>
<p>？？？？弱一致性</p>
<p>为什么？？迭代器不会报错</p>
<p><code>size</code>，<code>isEmpty</code>是近似值。</p>
<p>只有当需要加锁独占Map时，才考虑不使用ConcurrentHashMap。</p>
<h3 id="CopyOnWriteArrayList"><a href="#CopyOnWriteArrayList" class="headerlink" title="CopyOnWriteArrayList"></a><code>CopyOnWriteArrayList</code></h3><p>顾名思义 写入时复制，仅当迭代操作远大于修改操作时才使用，如监听模式。                                     </p>
<h3 id="阻塞队列"><a href="#阻塞队列" class="headerlink" title="阻塞队列"></a>阻塞队列</h3><p>······</p>
<h3 id="串行线程封闭"><a href="#串行线程封闭" class="headerlink" title="串行线程封闭"></a>串行线程封闭</h3><p>阻塞队列、对象池、ConcurrentHashMap的remove或者<code>AtomicReference</code>的<code>compareAndSet</code>来传递所有权。</p>
<h3 id="阻塞方法与中断异常"><a href="#阻塞方法与中断异常" class="headerlink" title="阻塞方法与中断异常"></a>阻塞方法与中断异常</h3><p> <code>InterruptedException</code>表示抛出这个异常的方法是一个阻塞方法，当发生中断时，它将抛出这个异常来结束阻塞状态。</p>
<p> 处理方法</p>
<ul>
<li>传递出去</li>
<li>恢复中断，<code>Thread.currentThread().interrupt();</code></li>
</ul>
<h3 id="同步工具类"><a href="#同步工具类" class="headerlink" title="同步工具类"></a>同步工具类</h3><h4 id="闭锁"><a href="#闭锁" class="headerlink" title="闭锁"></a>闭锁</h4><p>延迟线程的进度知道到达其终止状态。<code>CountDownLatch</code></p>
<h4 id="信号量"><a href="#信号量" class="headerlink" title="信号量"></a>信号量</h4><p>控制同时访问特定资源的操作的数量 <code>Semaphore</code></p>
<h4 id="栅栏"><a href="#栅栏" class="headerlink" title="栅栏"></a>栅栏</h4><p>闭锁是一次性的。闭锁等待事件，栅栏等待线程。规定数量的线程都等待时，才能继续执行。</p>
<p><code>CyclicBarrier</code>、<code>Exchanger</code></p>
</div></article><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a><a class="post-meta__tags" href="/tags/并发/">并发</a></div><nav id="pagination"><div class="next-post pull-right"><a href="/2019/07/24/Map/"><span>Map</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: 'e94bf9b4e03a31e9bc6f',
  clientSecret: '3b7cc7b3904a5506d84eb94dac8e7198084f8765',
  repo: 'mk014.github.io',
  owner: 'mk014',
  admin: 'mk014',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2019 By MK</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/Epsilon2.1.model.json"},"display":{"superSample":2,"width":210,"height":420,"position":"right","hOffset":0,"vOffset":-20},"log":false,"tagMode":false});</script></body></html>